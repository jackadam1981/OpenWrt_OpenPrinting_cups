# OpenWrt CUPS Package Build
# 从 downloads.openwrt.org 下载 SDK，产出 .ipk（opkg 格式，适配 24.10.x）
name: Build CUPS for OpenWrt

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  OPENWRT_VERSION: "24.10.0"

jobs:
  build:
    name: ${{ matrix.target }}/${{ matrix.subtarget }} build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            target: x86
            subtarget: "64"
          - arch: aarch64_cortex-a72
            target: mvebu
            subtarget: cortexa72
          - arch: aarch64_generic
            target: rockchip
            subtarget: armv8
          - arch: aarch64_cortex-a53_filogic
            target: mediatek
            subtarget: filogic
          - arch: mips_24kc
            target: malta
            subtarget: be
          - arch: mipsel_24kc
            target: ramips
            subtarget: mt7621
          - arch: mipsel_24kc_mt7620
            target: ramips
            subtarget: mt7620
          - arch: mipsel_24kc_rt305x
            target: ramips
            subtarget: rt305x
          - arch: mips_24kc_ath79
            target: ath79
            subtarget: generic
          - arch: mips_24kc_ath79_tiny
            target: ath79
            subtarget: tiny
          - arch: arm_cortex-a7_neon-vfpv4
            target: sunxi
            subtarget: cortexa7
          - arch: arm_cortex-a9
            target: mvebu
            subtarget: cortexa9
          - arch: powerpc_8548
            target: mpc85xx
            subtarget: p1020
          - arch: stm32-stm32mp1
            target: stm32
            subtarget: stm32mp1
          - arch: lantiq-xrx200_legacy
            target: lantiq
            subtarget: xrx200

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install zstd
        run: sudo apt-get update && sudo apt-get install -y zstd

      - name: Download and extract SDK
        id: sdk
        env:
          TARGET: ${{ matrix.target }}
          SUBTARGET: ${{ matrix.subtarget }}
        run: |
          BASE_URL="https://downloads.openwrt.org/releases/${OPENWRT_VERSION}/targets"
          TARGET_PATH="${TARGET}/${SUBTARGET}"
          INDEX=$(curl -sL "${BASE_URL}/${TARGET_PATH}/")
          SDK_FILE=$(echo "$INDEX" | grep -oE "openwrt-sdk-${OPENWRT_VERSION}-${TARGET}-${SUBTARGET}_[^\"]+\.tar\.zst" | head -1)
          [ -n "$SDK_FILE" ] || { echo "ERROR: Could not find SDK for ${TARGET_PATH}"; exit 1; }
          curl -sL -o sdk.tar.zst "${BASE_URL}/${TARGET_PATH}/${SDK_FILE}"
          tar -I zstd -xf sdk.tar.zst
          rm sdk.tar.zst
          SDK_DIR=$(find . -maxdepth 1 -type d -name "openwrt-sdk-*" | head -1)
          echo "dir=${SDK_DIR}" >> $GITHUB_OUTPUT
          echo "SDK_DIR=${SDK_DIR}" >> $GITHUB_ENV

      - name: Configure feed
        env:
          FEED_DIR: ${{ github.workspace }}
        run: |
          cd ${{ steps.sdk.outputs.dir }}
          [ -f feeds.conf ] || cp feeds.conf.default feeds.conf
          echo "src-link openprinting_cups $FEED_DIR" >> feeds.conf
          ./scripts/feeds update -a
          ./scripts/feeds install -p openprinting_cups -f cups
          make defconfig 2>/dev/null || true

      - name: Prepare CUPS source
        run: |
          cd ${{ steps.sdk.outputs.dir }}
          make package/cups/prepare -j$(nproc) V=s

      - name: Copy zh_CN Web templates (Web 管理界面中文模板)
        id: copy_zh_cn
        env:
          FEED_DIR: ${{ github.workspace }}
        run: |
          cd ${{ steps.sdk.outputs.dir }}
          CUPS_SRC=$(find build_dir -maxdepth 4 -type d -name "cups-2.4*" 2>/dev/null | head -1)
          echo "cups_src=${CUPS_SRC}" >> $GITHUB_OUTPUT
          if [ -n "$CUPS_SRC" ] && [ -d "$FEED_DIR/templates/zh_CN" ]; then
            echo "Copying Web UI zh_CN templates -> $CUPS_SRC/templates/zh_CN/"
            mkdir -p "$CUPS_SRC/templates/zh_CN"
            for f in "$FEED_DIR/templates/zh_CN/"*.tmpl; do [ -f "$f" ] && cp "$f" "$CUPS_SRC/templates/zh_CN/"; done
            echo "Templates in zh_CN: $(ls "$CUPS_SRC/templates/zh_CN/" 2>/dev/null | wc -l)"
            echo "--- templates/zh_CN 文件结构复查 ---"
            ls -la "$CUPS_SRC/templates/zh_CN/"
            echo "--- 与 templates/ja 对比（数量） ---"
            echo "zh_CN: $(ls "$CUPS_SRC/templates/zh_CN/"*.tmpl 2>/dev/null | wc -l) .tmpl"
            echo "ja:    $(ls "$CUPS_SRC/templates/ja/"*.tmpl 2>/dev/null | wc -l) .tmpl"
          else
            [ -z "$CUPS_SRC" ] && echo "Skip: CUPS source dir not found"
            [ ! -d "$FEED_DIR/templates/zh_CN" ] && echo "Skip: templates/zh_CN not found"
          fi

      - name: Debug - compile 前确认 zh_CN 在源码树
        run: |
          cd ${{ steps.sdk.outputs.dir }}
          CUPS_SRC="${{ steps.copy_zh_cn.outputs.cups_src }}"
          if [ -z "$CUPS_SRC" ] || [ ! -d "$CUPS_SRC" ]; then echo "Skip: CUPS_SRC not set"; exit 0; fi
          echo "=== 1. 复制后 templates/ 下语言目录 ==="
          ls -d "$CUPS_SRC"/templates/*/ 2>/dev/null || true
          echo "=== 2. templates/zh_CN 文件数 ==="
          ls "$CUPS_SRC/templates/zh_CN" 2>/dev/null | wc -l
          echo "=== 3. locale 中 cups_zh_CN.po（configure 用此生成 LANGUAGES）==="
          ls -la "$CUPS_SRC/locale/cups_zh_CN.po" 2>/dev/null || echo "not found"
          echo "=== 4. locale/ 下全部 .po（LANGUAGES 来源）==="
          ls -1 "$CUPS_SRC/locale"/cups_*.po 2>/dev/null | sed 's|.*/cups_||;s|\.po||' | tr '\n' ' '
          echo ""
          echo "=== 5. 模拟 cups-defaults.m4 的 LANGUAGES 值 ==="
          (cd "$CUPS_SRC" && ls -1 locale/cups_*.po 2>/dev/null | sed -e 's|locale/cups_||' -e 's|\.po||' | tr '\n' ' ')
          echo ""
          echo "=== 6. zh_CN 是否含 header.tmpl（FILES 需要）==="
          ls -la "$CUPS_SRC/templates/zh_CN/header.tmpl" 2>/dev/null || echo "not found"

      - name: Build CUPS packages
        run: |
          cd ${{ steps.sdk.outputs.dir }}
          make package/cups/compile -j$(nproc) V=s

      - name: Debug - compile 后 LANGUAGES 与 ipk 内 templates
        run: |
          cd ${{ steps.sdk.outputs.dir }}
          CUPS_SRC=$(find build_dir -maxdepth 4 -type d -name "cups-2.4*" 2>/dev/null | head -1)
          echo "=== 1. Makedefs LANGUAGES ==="
          grep -E "^LANGUAGES=" "$CUPS_SRC/Makedefs" 2>/dev/null || echo "not found"
          echo "=== 1b. LANGUAGES 是否包含 zh_CN ==="
          LANG_LINE=$(grep -E "^LANGUAGES=" "$CUPS_SRC/Makedefs" 2>/dev/null) || true
          if echo "$LANG_LINE" | grep -q "zh_CN"; then echo "是，zh_CN 在 LANGUAGES 中"; else echo "否，zh_CN 不在 LANGUAGES 中"; fi
          echo "=== 2. Makedefs DATADIR（make install 目标前缀）==="
          grep -E "^DATADIR=" "$CUPS_SRC/Makedefs" 2>/dev/null || echo "not found"
          echo "=== 3. compile 后 templates/ 语言目录 ==="
          ls -d "$CUPS_SRC"/templates/*/ 2>/dev/null || true
          echo "=== 3b. 模拟 templates/Makefile：LANGUAGES 中且存在 templates/ 的才会 install ==="
          LANGS=$(grep -E "^LANGUAGES=" "$CUPS_SRC/Makedefs" 2>/dev/null | sed 's/LANGUAGES=//;s/"//g')
          for lang in $LANGS; do
            if [ -d "$CUPS_SRC/templates/$lang" ]; then
              echo "  会安装: $lang ($(ls "$CUPS_SRC/templates/$lang" 2>/dev/null | wc -l) 文件)"
            else
              echo "  跳过(无目录): $lang"
            fi
          done
          echo "=== 4. build_dir 内含 templates 且含 ja/zh_CN 的目录（make install 实际写入位置）==="
          find build_dir -type d -name "templates" 2>/dev/null | while read d; do
            if [ -d "$d/ja" ] || [ -d "$d/zh_CN" ]; then
              echo "  -> $d"
              ls "$d" 2>/dev/null | head -20
              echo "  zh_CN 数量: $(ls "$d/zh_CN" 2>/dev/null | wc -l)"
            fi
          done
          echo "=== 5. ipk 内 usr/share/cups/templates/（列表）==="
          IPK=$(find . -path "./openwrt-sdk-*/bin/*/packages/*/cups-mini_*.ipk" 2>/dev/null | head -1)
          if [ -n "$IPK" ]; then
            (tar -tzf "$IPK" 2>/dev/null || ar p "$IPK" data.tar.gz 2>/dev/null | tar -tz) | grep "usr/share/cups/templates/" | head -80
            echo "=== 6. 解包 ipk 验证 zh_CN（tar.gz 格式，与文档一致）==="
            mkdir -p /tmp/ipk-check && cd /tmp/ipk-check && rm -rf usr data.tar.gz control.tar.gz debian-binary 2>/dev/null
            if tar -xzf "$OLDPWD/$IPK" 2>/dev/null; then
              tar -xzf data.tar.gz 2>/dev/null
            else
              (cd "$OLDPWD" && ar x "$IPK" data.tar.gz 2>/dev/null) && cp "$OLDPWD/data.tar.gz" . && tar -xzf data.tar.gz
            fi
            echo "usr/share/cups/templates/ 目录："
            ls -la usr/share/cups/templates/ 2>/dev/null || echo "not found"
            echo "zh_CN 模板数："
            ls usr/share/cups/templates/zh_CN/ 2>/dev/null | wc -l || echo "0"
            echo "ja 数量（对照）："
            ls usr/share/cups/templates/ja/ 2>/dev/null | wc -l || echo "0"
          else
            echo "ipk not found"
          fi
          echo "=== 7. OpenWrt 包 staging 目录（ipkg-* 或 root-* 下 usr/share/cups）==="
          for root in build_dir/target-*/root-* build_dir/target-*/ipkg-*; do
            [ -d "$root" ] || continue
            if [ -d "$root/usr/share/cups/templates" ]; then
              echo "  -> $root/usr/share/cups/templates"
              ls "$root/usr/share/cups/templates" 2>/dev/null | head -25
              echo "  zh_CN: $(ls "$root/usr/share/cups/templates/zh_CN" 2>/dev/null | wc -l)"
            fi
          done 2>/dev/null || true

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: cups-${{ matrix.arch }}-packages
          path: openwrt-sdk-*/bin/**/cups*.ipk
          if-no-files-found: warn

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cups-${{ matrix.arch }}-logs
          path: openwrt-sdk-*/logs/
          if-no-files-found: ignore
