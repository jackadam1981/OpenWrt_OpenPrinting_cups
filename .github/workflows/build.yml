# OpenWrt CUPS Package Build
# 从 downloads.openwrt.org 下载 SDK，产出 .ipk（opkg 格式，适配 24.10.x）
name: Build CUPS for OpenWrt

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  OPENWRT_VERSION: "24.10.0"

jobs:
  build:
    name: ${{ matrix.target }}/${{ matrix.subtarget }} build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            target: x86
            subtarget: "64"
          - arch: aarch64_cortex-a72
            target: mvebu
            subtarget: cortexa72
          - arch: aarch64_generic
            target: rockchip
            subtarget: armv8
          - arch: mips_24kc
            target: malta
            subtarget: be
          - arch: mipsel_24kc
            target: ramips
            subtarget: mt7621
          - arch: arm_cortex-a7_neon-vfpv4
            target: sunxi
            subtarget: cortexa7
          - arch: arm_cortex-a9
            target: mvebu
            subtarget: cortexa9
          - arch: powerpc_8548
            target: mpc85xx
            subtarget: p1020
          - arch: stm32-stm32mp1
            target: stm32
            subtarget: stm32mp1
          - arch: lantiq-xrx200_legacy
            target: lantiq
            subtarget: xrx200

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install zstd
        run: sudo apt-get update && sudo apt-get install -y zstd

      - name: Build CUPS packages
        env:
          FEED_DIR: ${{ github.workspace }}
        run: |
          chmod +x .github/scripts/build-with-sdk.sh
          .github/scripts/build-with-sdk.sh ${{ matrix.target }} ${{ matrix.subtarget }}

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: cups-${{ matrix.arch }}-packages
          path: openwrt-sdk-*/bin/**/cups*.ipk
          if-no-files-found: warn

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cups-${{ matrix.arch }}-logs
          path: openwrt-sdk-*/logs/
          if-no-files-found: ignore
