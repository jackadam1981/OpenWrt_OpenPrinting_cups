# OpenWrt CUPS Package Build
# 从 downloads.openwrt.org 下载 SDK，产出 .ipk（opkg 格式，适配 24.10.x）
name: Build CUPS for OpenWrt

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  OPENWRT_VERSION: "24.10.0"

jobs:
  build:
    name: ${{ matrix.target }}/${{ matrix.subtarget }} build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            target: x86
            subtarget: "64"
          - arch: aarch64_cortex-a72
            target: mvebu
            subtarget: cortexa72
          - arch: aarch64_generic
            target: rockchip
            subtarget: armv8
          - arch: aarch64_cortex-a53_filogic
            target: mediatek
            subtarget: filogic
          - arch: mips_24kc
            target: malta
            subtarget: be
          - arch: mipsel_24kc
            target: ramips
            subtarget: mt7621
          - arch: mipsel_24kc_mt7620
            target: ramips
            subtarget: mt7620
          - arch: mipsel_24kc_rt305x
            target: ramips
            subtarget: rt305x
          - arch: mips_24kc_ath79
            target: ath79
            subtarget: generic
          - arch: mips_24kc_ath79_tiny
            target: ath79
            subtarget: tiny
          - arch: arm_cortex-a7_neon-vfpv4
            target: sunxi
            subtarget: cortexa7
          - arch: arm_cortex-a9
            target: mvebu
            subtarget: cortexa9
          - arch: powerpc_8548
            target: mpc85xx
            subtarget: p1020
          - arch: stm32-stm32mp1
            target: stm32
            subtarget: stm32mp1
          - arch: lantiq-xrx200_legacy
            target: lantiq
            subtarget: xrx200

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install zstd
        run: sudo apt-get update && sudo apt-get install -y zstd

      - name: Download and extract SDK
        id: sdk
        env:
          TARGET: ${{ matrix.target }}
          SUBTARGET: ${{ matrix.subtarget }}
        run: |
          BASE_URL="https://downloads.openwrt.org/releases/${OPENWRT_VERSION}/targets"
          TARGET_PATH="${TARGET}/${SUBTARGET}"
          INDEX=$(curl -sL "${BASE_URL}/${TARGET_PATH}/")
          SDK_FILE=$(echo "$INDEX" | grep -oE "openwrt-sdk-${OPENWRT_VERSION}-${TARGET}-${SUBTARGET}_[^\"]+\.tar\.zst" | head -1)
          [ -n "$SDK_FILE" ] || { echo "ERROR: Could not find SDK for ${TARGET_PATH}"; exit 1; }
          curl -sL -o sdk.tar.zst "${BASE_URL}/${TARGET_PATH}/${SDK_FILE}"
          tar -I zstd -xf sdk.tar.zst
          rm sdk.tar.zst
          SDK_DIR=$(find . -maxdepth 1 -type d -name "openwrt-sdk-*" | head -1)
          echo "dir=${SDK_DIR}" >> $GITHUB_OUTPUT
          echo "SDK_DIR=${SDK_DIR}" >> $GITHUB_ENV

      - name: Configure feed
        env:
          FEED_DIR: ${{ github.workspace }}
        run: |
          cd ${{ steps.sdk.outputs.dir }}
          [ -f feeds.conf ] || cp feeds.conf.default feeds.conf
          echo "src-link openprinting_cups $FEED_DIR" >> feeds.conf
          ./scripts/feeds update -a
          ./scripts/feeds install -p openprinting_cups -f cups
          make defconfig 2>/dev/null || true

      - name: Prepare CUPS source
        run: |
          cd ${{ steps.sdk.outputs.dir }}
          make package/cups/prepare -j$(nproc) V=s

      - name: Copy zh_CN Web templates (Web 管理界面中文模板)
        env:
          FEED_DIR: ${{ github.workspace }}
        run: |
          cd ${{ steps.sdk.outputs.dir }}
          CUPS_SRC=$(find build_dir -maxdepth 4 -type d -name "cups-2.4*" 2>/dev/null | head -1)
          if [ -n "$CUPS_SRC" ] && [ -d "$FEED_DIR/templates/zh_CN" ]; then
            echo "Copying Web UI zh_CN templates -> $CUPS_SRC/templates/zh_CN/"
            mkdir -p "$CUPS_SRC/templates/zh_CN"
            for f in "$FEED_DIR/templates/zh_CN/"*.tmpl; do [ -f "$f" ] && cp "$f" "$CUPS_SRC/templates/zh_CN/"; done
            echo "Templates in zh_CN: $(ls "$CUPS_SRC/templates/zh_CN/" 2>/dev/null | wc -l)"
          else
            [ -z "$CUPS_SRC" ] && echo "Skip: CUPS source dir not found"
            [ ! -d "$FEED_DIR/templates/zh_CN" ] && echo "Skip: templates/zh_CN not found"
          fi

      - name: Build CUPS packages
        run: |
          cd ${{ steps.sdk.outputs.dir }}
          make package/cups/compile -j$(nproc) V=s

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: cups-${{ matrix.arch }}-packages
          path: openwrt-sdk-*/bin/**/cups*.ipk
          if-no-files-found: warn

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cups-${{ matrix.arch }}-logs
          path: openwrt-sdk-*/logs/
          if-no-files-found: ignore
